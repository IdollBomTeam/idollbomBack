<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.idollbom.mapper.mainmapper.RecommendMapper">
    <!--  전문가 추천  -->
    <select id="recommend">
        SELECT *
        FROM (
                SELECT ROWNUM AS RN, RECOM.*
                FROM (
                        SELECT
                          P.PRO_PROFILE_IMAGE_URL,
                          P.PRO_NAME,
                          COALESCE(AVG(R.REVIEW_EVALUTION_POINT), 0) AS averageRating,  -- 평균 평점이 NULL이면 0으로 대체
                          COUNT(R.REVIEW_NUMBER) AS reviewCount                         -- 리뷰 개수
                        FROM PRO P JOIN CLASS C ON P.PRO_NUMBER = C.PRO_NUMBER
                                   JOIN REVIEW R on C.CLASS_NUMBER = R.CLASS_NUMBER
                        GROUP BY
                          P.PRO_NAME,
                          P.PRO_PROFILE_IMAGE_URL
                        ORDER BY averageRating DESC
                    ) RECOM
                WHERE ROWNUM &lt;= #{endRow}
            )
        WHERE RN &gt; #{startRow}
    </select>

    <!--  전문가 총 수 ( 단, 진행하는 수업이 있고, 수업에 대한 리뷰가 있어야 한다. )  -->
    <select id="getCount">
        select COUNT(*)
        from (
                  SELECT
                      P.PRO_PROFILE_IMAGE_URL,
                      P.PRO_NAME,
                      COALESCE(AVG(R.REVIEW_EVALUTION_POINT), 0) AS averageRating,  -- 평균 평점이 NULL이면 0으로 대체
                      COUNT(R.REVIEW_NUMBER) AS reviewCount                         -- 리뷰 개수
                  FROM PRO P JOIN CLASS C ON P.PRO_NUMBER = C.PRO_NUMBER
                             JOIN REVIEW R on C.CLASS_NUMBER = R.CLASS_NUMBER
                  GROUP BY
                      P.PRO_NAME,
                      P.PRO_PROFILE_IMAGE_URL
                  ORDER BY averageRating DESC
        )
    </select>

</mapper>