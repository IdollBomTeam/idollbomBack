<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.idollbom.mapper.applymapper.ClassDetailMapper">
    <!-- 수업 상세보기 조회 -->
    <select id="selectClassByProNumber">
        SELECT CL.CLASS_CATEGORY_BIG,
               CL.CLASS_CATEGORY_SMALL,
               CL.CLASS_NUMBER,
               CL.PRO_NAME,
               CL.PRO_NUMBER,

        FROM (
                 SELECT
                     I.IMAGE_FILE_URL,
                     I.IMAGE_NUMBER,
                     CLASS.PRO_NUMBER,
                     CLASS.PRO_NAME,
                     CLASS.CLASS_NUMBER,
                     CLASS.CLASS_NAME,
                     CLASS.CLASS_CATEGORY_BIG,
                     CLASS.CLASS_CATEGORY_SMALL,
                     CLASS.CLASS_CONTENT,
                     CLASS.CLASS_PAYMENT_ACCOUNT,
                     TO_CHAR(CLASS.CLASS_REGISTER_DATE, 'YYYY-MM-DD / HH24') || '시'  AS CLASS_REGISTER_DATE
                 FROM
                     (
                         SELECT
                             P.*,
                             C.CLASS_CATEGORY_BIG,
                             C.CLASS_CATEGORY_SMALL,
                             C.CLASS_CONTENT,
                             C.CLASS_NAME,
                             C.CLASS_NUMBER,
                             C.CLASS_PAYMENT_ACCOUNT,
                             C.CLASS_REGISTER_DATE
                         FROM PRO P JOIN CLASS C
                            ON P.PRO_NUMBER = C.PRO_NUMBER
                            AND C.PRO_NUMBER = #{proNumber}
                     ) CLASS JOIN IMG I
                        ON CLASS.CLASS_NUMBER = I.CLASS_NUMBER
             ) CL JOIN
             (
                 SELECT *
                 FROM (
                         SELECT
                             D.RESERVATION_DATE_NUMBER,
                             D.CLASS_NUMBER,
                             D.RESERVATION_DATE,
                             T.RESERVATION_TIME
                         FROM RESERVATION_DATE D JOIN RESERVATION_TIME T
                          ON D.RESERVATION_DATE_NUMBER = T.RESERVATION_DATE_NUMBER
                          AND D.RESERVATION_DATE_NUMBER = #{reservationDateNumber}
                     )
                 WHERE RESERVATION_DATE = #{reservationDate}
                   AND RESERVATION_TIME = #{reservationTime}
             ) RE
             ON CL.CLASS_NUMBER = RE.CLASS_NUMBER;
    </select>

</mapper>